name: Desktop Tauri CI

on:
  pull_request:
    branches: [ "main", "mobile/v0.5.0" ]
  push:
    branches: [ "main", "mobile/v0.5.0" ]

jobs:
  desktop:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/desktop/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend deps
        working-directory: apps/desktop
        run: npm ci

      - name: Build frontend
        working-directory: apps/desktop
        run: npm run build

      - name: Cargo check workspace
        run: cargo check --workspace

      - name: Cargo test workspace
        run: cargo test --workspace

      - name: Fetch runtime assets
        run: npm run runtime:fetch

      - name: Build portable artifact
        run: npm run dist

      - name: Verify portable artifact contents
        shell: pwsh
        run: |
          $zip = Get-ChildItem "release" -Filter "LyricVault.Portable.*.zip" |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $zip) {
            throw "Portable zip not found in release/"
          }

          $extractDir = Join-Path $env:RUNNER_TEMP "portable-verify"
          if (Test-Path $extractDir) {
            Remove-Item $extractDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $extractDir -Force | Out-Null
          Expand-Archive -Path $zip.FullName -DestinationPath $extractDir -Force

          $required = @(
            "LyricVault.exe",
            "python-embed\python.exe",
            "ffmpeg\ffmpeg.exe",
            "backend\tools\bridge_cli.py"
          )
          foreach ($item in $required) {
            $path = Join-Path $extractDir $item
            if (-not (Test-Path $path)) {
              throw "Required portable artifact content missing: $item"
            }
          }

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: lyricvault-portable
          path: release/LyricVault.Portable.*.zip

      - name: Upload installer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lyricvault-installers
          path: |
            target/release/bundle/nsis/*.exe
            target/release/bundle/msi/*.msi
