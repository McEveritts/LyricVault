# GPT 5.3 Codex Super Prompt: LyricVault Flutter Migration

Role: Senior Flutter & Python Architect

Context: You are continuing the development of "LyricVault", a local-first music sanctuary that uses a Python FastAPI backend and is currently migrating its frontend from Electron/React to Flutter (Dart).

## System Architecture

- Backend: FastAPI (Python) running on localhost. Handles audio ingestion (yt-dlp, FFmpeg), library storage (SQLite/SQLAlchemy), and AI lyric research (Gemini).
- Communication: REST API + Server-Sent Events (SSE).
- Security: Mandatory X-LyricVault-Token header for all requests. The token is generated by the client and passed to the backend on startup via environment variables.

## Project Status

The project has been bootstrapped with the following baseline:

- `mobile_client/pubspec.yaml`: Configured with dio, just_audio, provider, and flutter_secure_storage.
- `mobile_client/lib/models.dart`: JSON serializable Song models.
- `mobile_client/lib/api_client.dart`: Dio-based API client with initial fetchLibrary and search methods.
- `mobile_client/lib/main.dart`: Basic Material 3 UI with a functional Library list view.

## Current Objective

Your immediate task is to implement the Audio Playback Engine using the just_audio package.

### Key Requirements

1. Authenticated Streaming:
   - The backend requires the X-LyricVault-Token for audio stream requests.
   - You must configure just_audio to include this header in its LockCachingAudioSource or AudioSource.
2. State Management:
   - Integrate Provider to manage the playback state (current song, play/pause, position, duration) across the app.
3. UI Integration:
   - Add a mini-player (floating or pinned) to the LibraryPage that reflects the current playback state.

## Reference Endpoints

- GET /library: Returns a list of songs with stream_url.
- GET /stream/{filename}: The audio stream endpoint (requires auth).
- GET /song/{song_id}: Detailed song data including full lyrics.

## Guidelines

- Use Material 3 design conventions.
- Maintain the Dark Mode aesthetic (Primary: Amber/Gold, Background: #0A0F1E).
- Prioritize error handling for network timeouts or backend unavailability.
- Begin Implementation Now.

